<!DOCTYPE html>
<meta charset="UTF-8">
<meta http-equiv="Content-Language" content="fr" /> 
<meta http-equiv=“Pragma” content=”no-cache”>
<meta http-equiv=“Expires” content=”-1″>
<meta http-equiv=“CACHE-CONTROL” content=”NO-CACHE”>
<html>
<head>
<!--link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"-->
<script src="https://kit.fontawesome.com/f22da9fa3e.js" crossorigin="anonymous"></script>
<style>
  svg { outline: 3px solid black; }
  
  .draggable { cursor: move;}
  .attacher { cursor: zoom-in;}
  .detacher { cursor: zoom-out;}
    
  .i1 { width:30px; padding:4px; margin:0px;}
  .b1 { 
		background-color: DodgerBlue; border: none; color: white; cursor: pointer;
		text-decoration: none; display: inline-block; padding:4px; text-align: center; vertical-align: middle; } 
		
	.b1:hover { background-color: RoyalBlue; }		
}
</style>
</head>
<body onload="debut()">
  <svg xmlns="http://www.w3.org/2000/svg" id="leSvg" height="297mm" width="420mm"></svg> 
  <svg xmlns="http://www.w3.org/2000/svg" id="mm" height="100mm" width="100mm"></svg> 
  </br>
	<button class="b1" onclick="sauveSVG()"><i class="fas fa-download"></i>SVG</button>
	<button class="b1" onclick="debut()"><i class="far fa-file"></i>Nouveau</button>
	<button class="b1" onclick="sauveDonnees()"><i class="fas fa-download"></i>Data</button>
	<input class="i1" type="text" id="rech" value=""><button onclick="redeploie()" class="b1"><i class="fa fa-search"></i></button>
	<i id="blaCourant">Courant:</i><input class="i1" type="text" id="courant" value="">
	
	<button class="b1" onclick="tourneTriangle(1)"><i class="fas fa-undo"></i></button>
	<button class="b1" onclick="tourneTriangle(-1)"><i class="fas fa-redo"></i></button>
	<button class="b1" onclick="bougePiece( 1, 0)"><i class="fas fa-arrow-left"></i></button>
	<button class="b1" onclick="bougePiece( 0,-1)"><i class="fas fa-arrow-down"></i></button>
	<button class="b1" onclick="bougePiece( 0, 1)"><i class="fas fa-arrow-up"></i></button>
	<button class="b1" onclick="bougePiece(-1, 0)"><i class="fas fa-arrow-right"></i></button>

<script>
var nn = 0, epsilon = 0.001, fZoom, tP1 = 11, tP2 = 9
var Triangles = [], Pages = [], Lignes = [], Nums = [], lec = []
volume = function () {
let faces =[[0,44,7],[0,52,43],[1,13,12],[1,42,4],[1,44,42],[1,52,7],[2,40,4],[2,41,40],[2,42,41],[3,9,4],[3,28,5],[3,40,28],[4,9,1],[4,40,3],[4,42,2],[5,9,3],[5,11,9],[5,29,11],[5,31,29],[6,28,25],[6,31,28],[6,60,19],[6,71,60],[7,44,1],[7,52,0],[8,46,45],[8,47,41],[8,71,40],[9,13,1],[9,27,13],[10,53,12],[10,58,53],[11,27,9],[11,30,14],[12,13,10],[12,52,1],[12,53,52],[13,16,10],[13,27,16],[14,23,15],[14,27,11],[14,64,21],[15,18,17],[15,23,18],[15,27,14],[15,57,16],[16,27,15],[16,57,10],[17,57,15],[17,58,57],[17,66,55],[18,32,24],[18,66,17],[18,77,66],[19,30,6],[19,60,50],[19,64,30],[20,22,21],[20,36,22],[20,64,33],[21,23,14],[21,64,20],[22,23,21],[22,36,26],[22,67,23],[23,32,18],[23,67,32],[24,77,18],[24,79,77],[25,71,6],[26,36,35],[26,67,22],[28,31,5],[28,40,25],[29,30,11],[29,31,30],[30,31,6],[30,64,14],[32,39,24],[32,67,37],[33,35,20],[33,69,34],[33,78,69],[34,35,33],[34,67,35],[34,69,67],[35,36,20],[35,67,26],[37,39,32],[37,67,38],[38,39,37],[38,68,59],[38,79,39],[39,79,24],[40,47,8],[40,71,25],[41,46,8],[41,47,40],[42,46,41],[42,49,45],[43,44,0],[43,49,44],[43,52,49],[44,49,42],[45,46,42],[45,70,8],[45,73,70],[48,72,51],[48,75,72],[49,58,55],[49,73,45],[50,64,19],[50,75,54],[51,70,48],[51,71,70],[51,72,60],[52,53,49],[53,58,49],[54,63,50],[54,73,56],[54,74,73],[54,75,74],[55,58,17],[55,66,56],[55,73,49],[56,63,54],[56,66,59],[56,73,55],[57,58,10],[59,61,56],[59,62,61],[59,68,62],[59,77,38],[60,71,51],[60,72,50],[61,63,56],[61,65,63],[62,65,61],[62,76,65],[63,64,50],[63,78,64],[64,78,33],[65,76,69],[65,78,63],[66,77,59],[67,68,38],[67,76,68],[68,76,62],[69,76,67],[69,78,65],[70,71,8],[70,73,48],[72,75,50],[73,74,48],[74,75,48],[77,79,38]]
let vertices = [[-0.79508661,20.96609345,16.37343018],[-8.22914161,13.98059345,7.22516118],[-7.40571961,30.81744245,2.15907118],[-9.27822561,30.72870545,-8.52919982],[-8.60394261,27.85787445,-1.50807782],[-12.80329361,12.74718345,-3.49944882],[-4.67611061,18.29598445,-10.70843682],[-7.07507461,18.68410345,12.37277418],[6.99330339,39.79478345,-7.53510882],[-10.27839361,15.02815545,0.91086418],[0.14862839,9.35439545,14.44037818],[-11.92157361,4.79556545,-1.78444882],[-4.60372661,13.45934545,13.02678918],[-8.65333961,5.28797445,12.64499918],[-11.85803361,-3.06271455,-1.95080782],[-6.38757661,-6.40529555,12.06034318],[-8.20815761,-2.06382455,18.24144918],[4.88312539,-6.53522655,12.43087218],[-2.67027361,-9.79665555,11.86218518],[-4.45661761,3.03729545,-7.96878582],[-21.40756361,-11.76813555,-8.16591782],[-20.59258361,-8.11850555,-2.78316682],[-22.74570361,-15.10359555,2.78628318],[-12.11340361,-9.49717555,5.60870218],[1.16371239,-18.08221755,16.14746318],[-4.76020961,36.93561445,-15.65127782],[-22.20334361,-22.81923255,4.17087418],[-13.15011361,0.019533446,6.88546218],[-10.93098361,29.64612445,-12.30310582],[-13.54154361,5.29149545,-7.32958782],[-8.57363361,4.17489545,-6.72984882],[-10.46839361,19.03300345,-8.75345782],[-11.02602361,-16.50021655,13.65268918],[-12.71452361,-13.66430155,-11.74324982],[-12.13148361,-22.81412655,-12.22643882],[-19.59743461,-22.81398755,-10.24035782],[-23.80681361,-22.75423355,-3.59041782],[-10.89750361,-22.80946155,14.81531018],[15.64177639,-22.81684355,8.22053318],[-1.76692661,-22.80203055,17.35661518],[-7.27784661,39.81833545,-8.91151582],[0.15211539,34.18935245,3.15695418],[-0.16643761,29.45721345,2.05611218],[6.03169639,19.38031245,13.38723918],[-0.04741761,25.33107645,6.36746018],[8.53902039,28.06436445,-1.46912982],[6.28116739,31.44413645,2.97882318],[-2.65868161,39.93733445,-5.63754782],[10.95210639,22.06790445,-6.07313682],[9.20395939,13.76607345,6.02864318],[6.90608039,3.13712345,-7.30200782],[10.09931639,28.56582545,-12.42527982],[1.60700639,15.24792345,11.08495518],[5.30351839,11.20197545,12.86097118],[10.40917639,3.77541445,-4.17156782],[13.08880639,0.082274446,5.62169118],[11.75653639,-3.18427555,-0.36598782],[2.60212739,-2.28216455,20.25274818],[10.15114639,-1.75883655,15.51521518],[15.22935639,-14.32976255,6.60329218],[4.15521939,16.17339545,-10.16774882],[20.12047639,-8.92552555,-1.03703882],[24.01385539,-15.22149055,-0.71990782],[9.51686839,-2.27244455,-7.64215682],[-5.30689561,-2.04796555,-8.53680582],[20.20950539,-10.03486555,-8.74306682],[8.59161939,-9.09733555,9.11871118],[-15.48214361,-22.81300055,8.20394318],[22.49298739,-22.81963655,3.74205218],[14.36783639,-22.82025955,-11.94132782],[9.18303939,31.23269545,-8.68467882],[5.85688539,36.60264445,-16.07235882],[10.39551639,19.01195445,-8.79430982],[11.92790639,6.18596545,-0.47921882],[14.24007639,5.88211545,-2.61879882],[13.15473639,5.86999345,-7.52027682],[22.88881539,-22.81562455,-7.09133682],[11.40455639,-15.72926255,12.96756218],[12.27152639,-14.66391355,-12.15158682],[9.65503539,-22.79941055,15.85240418]]
let groups = [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
return {faces:faces, vertices:vertices, groups:groups}
}
const svgNS = "http://www.w3.org/2000/svg" , gLargeur = document.getElementById('leSvg').width.baseVal.value
var vol, donnees, pCourante, selEl = null, sElOffset, sCoord, poseCourant
var rechEnCours = false;
function initVolume(){
  if(!vol){
		//fZoom = 3*4
		fZoom = 10
		vol = volume() 
		vol.vertices = vol.vertices.map(x=> x.map(y=> y*fZoom))
	}
}
function debut(){
  initVolume()
	var max = vol.faces.length -1
	var n = prompt("Commencer par quelle facette (0 - "+ max +") ?", "0")
	
	if (n != null) {
		n = parseInt(n)
		console.log(n)
		if( (n<0) || (n > max)){
			n = getRandomInt(max)
		}
		donnees = {
		pages:[
			[	{n:n, x:750,y:550, a:0}
			]
		]
	}
	makeDraggable()
	redeploie()
	}
}

function makeDraggable(){
//http://www.petercollingridge.co.uk/tutorials/svg/interactive/dragging/	
	var svg = document.getElementById("leSvg")
  svg.addEventListener('mousedown', startDrag);
  svg.addEventListener('mousemove', drag);
  svg.addEventListener('mouseup', endDrag);
  svg.addEventListener('mouseleave', endDrag);

  function getMousePosition(evt) {
    var CTM = svg.getScreenCTM();
    return {
      x: (evt.clientX - CTM.e) / CTM.a,
      y: (evt.clientY - CTM.f) / CTM.d
    };
  }
 
function startDrag(evt) {
	if (evt.target.classList.contains('draggable')) {
		selEl = evt.target
		poseCourant = selEl.textContent
		document.getElementById("courant").value = poseCourant
		sCoord = [
			parseFloat(selEl.getAttributeNS(null, "x")),
			parseFloat(selEl.getAttributeNS(null, "y"))
		]
		sElOffset = getMousePosition(evt)
		sElOffset.x -= parseFloat(sCoord[0])
		sElOffset.y -= parseFloat(sCoord[1])
	}
}
function drag(evt) {
	if (selEl) {
		evt.preventDefault();
    var coord = getMousePosition(evt)
    var nx = coord.x - sElOffset.x
    var ny = coord.y - sElOffset.y
    selEl.setAttributeNS(null, "x", nx);
    selEl.setAttributeNS(null, "y", ny);
	}
}
function endDrag(evt) {

  if(selEl){
		var coord = getMousePosition(evt)
		delta = [
		  sCoord[0] - parseFloat(selEl.getAttributeNS(null, "x")),
		  sCoord[1] - parseFloat(selEl.getAttributeNS(null, "y"))
		]
		
		t = donnees.pages[pCourante-1].find(x=>x.n == selEl.textContent)
		t.x -= delta[0]
		t.y -= delta[1]
		
		selEl = null
		redeploie()
	}
}
}

function bougePiece(dx, dy){
	if(!poseCourant){ poseCourant = document.getElementById("courant").value}
	t = donnees.pages[pCourante-1].find(x=>x.n == poseCourant)
	t.x -= dx
	t.y -= dy
		
	redeploie()
}
function tourneTriangle(sens){
	var n = document.getElementById("courant").value
	if(n){
		var t = donnees.pages[pCourante-1].find(x=>x.n == n)
		t.a = t.a + sens
		redeploie()
	}
}
function sauveSVG(){
// 1. Keep a DOM reference to the SVG element
var SVGDomElement = document.getElementById("leSvg");

// 2. Serialize element into plain SVG
var serializedSVG = new XMLSerializer().serializeToString(SVGDomElement);

const blob = new Blob([serializedSVG], {type: 'image/svg+xml'});
let objectURL = window.URL.createObjectURL(blob);
let anchor = document.createElement('a');

anchor.href = objectURL;
anchor.download = name;
anchor.click();

URL.revokeObjectURL(objectURL);
}
function d2ize(p){
// https://stackoverflow.com/a/8051489
var x0 = p[0][0], y0 = p[0][1], z0 = p[0][2],
    x1 = p[1][0], y1 = p[1][1], z1 = p[1][2],
    x2 = p[2][0], y2 = p[2][1], z2 = p[2][2]
    
var X0 = 0, Y0 = 0
var X1 = Math.sqrt((x1 - x0)*(x1 - x0) + (y1 - y0)*(y1 - y0) + (z1 - z0)*(z1 - z0)),
    Y1 = 0
var X2 = ((x1 - x0) * (x2 - x0) + (y1 - y0) * (y2 - y0) + (z1 - z0) * (z2 - z0)) / X1,
    Y2 = Math.sqrt((x2 - x0)*(x2 - x0) + (y2 - y0)*(y2 - y0) + (z2 - z0)*(z2 - z0) - X2*X2)
    
//return [[X0, gLargeur-Y0], [X1, gLargeur-Y1], [X2, gLargeur-Y2]]
return [[X0, Y0], [X1, Y1], [X2, Y2]]

}
function distance2d(p1, p2){
  var a = p2[0] - p1[0]
  var b = p2[1] - p1[1]

  return Math.sqrt(a*a + b*b)
}
function distance(p1, p2) {
  var a = p2[0] - p1[0]
  var b = p2[1] - p1[1]
  var c = p2[2] - p1[2]

  return Math.sqrt(a * a + b * b + c * c)
}
function rad2deg(r){ return r * (180 / Math.PI)}
function rotation(cx, cy, x, y, angle) {
  var radians = (Math.PI / 180) * angle,
      cos = Math.cos(radians),
      sin = Math.sin(radians),
      nx = (cos * (x - cx)) + (sin * (y - cy)) + cx,
      ny = (cos * (y - cy)) - (sin * (x - cx)) + cy

  return [nx, ny]
}
function getRandomInt(max) {
  return Math.floor(Math.random() * Math.floor(max));
}
function coordonneesDepuisDistances(d){
  var a = d[0], b = d[1], c = d[2], result = [0,0];

  if(a > 0){
    result[0] = (c*c - b*b + a*a) / (2*a);
  }

  result[1] = Math.sqrt(c*c - result[0]*result[0]);
  return result;
}
function centroid(pts){
  var a = pts[0], b = pts[1], c = pts[2] 
  var cX = ((a[0] + b[0] + c[0]) / 3)
  var cY = ((a[1] + b[1] + c[1]) / 3)
  //var cZ = ((a[2] + b[2] + c[2]) / 3)

  return [cX, cY]
}
function milieu(a, b){
  var cX = ((a[0] + b[0]) / 2)
  var cY = ((a[1] + b[1]) / 2)

  return [cX, cY]
}
function calculeDistances(v, triangle){
  var p3A = v.vertices[triangle[0]]
  var p3B = v.vertices[triangle[1]]
  var p3C = v.vertices[triangle[2]]
  var a = distance(p3B, p3C)
  var b = distance(p3C, p3A)
  var c = distance(p3A, p3B)

  return [a, b, c]
}
function calculeAngles(d){
  var a = d[0], b = d[1], c = d[2]
  
  var aA = Math.acos((b*b + c*c - a*a) / (2 * b * c))
  var aB = Math.acos((c*c + a*a - b*b) / (2 * c * a))
  var aC = Math.acos((a*a + b*b - c*c) / (2 * a * b))

  return [aA, aB, aC]
}
function rechercheVoisin(nFace, rech, tableau){
  return tableau.findIndex(function(el, i){return (i!== nFace) && el.includes(rech[0]) && el.includes(rech[1])})
}
function troisiemePoint(triangle, pts){
  return triangle.findIndex(el => (el != pts[0]) && (el != pts[1]) )
}
function angle(p1, p2){
  var cx= p1[0], cy= p1[1], ex = p2[0], ey= p2[1]
  var dy = ey - cy
  var dx = ex - cx
  var theta = Math.atan2(dy, dx) // range (-PI, PI]
  //theta *= 180 / Math.PI; // rads to degs, range (-180, 180]
  //if (theta < 0) theta = 360 + theta; // range [0, 360)
  return theta
}
function deplace(x, y, dx, x1, y1, x2, y2){ 
// https://stackoverflow.com/a/38994057
  var a = [x2 - x1, y2 - y1],
      mag = Math.sqrt(a[0]*a[0] + a[1]*a[1])
  if (mag == 0) {
    a[0] = a[1] = 0
  } else {
    a[0] = a[0] / mag * dx
    a[1] = a[1] / mag * dx
  }
  return [x + a[0], y + a[1]]
}
function calculeAngleBAC(A, B, C){
  var AB = [B[0]-A[0], B[1]-A[1]]
  var AC = [C[0]-A[0], C[1]-A[1]]
  var ang = Math.atan2((AB[0]*AC[0])+(AB[1]*AC[1]), (AB[1]*AC[0])-(AB[0]*AC[1]))

  return ang
}
function ajoutePoly(pts, source = "leSvg"){
  var tri = document.createElementNS(svgNS, "polygon")
  tri.setAttributeNS(null, "style", "fill:none;stroke:black;stroke-width:1")
  var fPts = pts.flat()
  tri.setAttributeNS(null, "points", fPts)
  document.getElementById(source).appendChild(tri)
}
function ajouteRect(x, y, h, w, f, source = "leSvg"){
  var rect = document.createElementNS(svgNS, 'rect')
  rect.setAttributeNS(null, 'x', x);
  rect.setAttributeNS(null, 'y', y);
  rect.setAttributeNS(null, 'height', h);
  rect.setAttributeNS(null, 'width', w);
  rect.setAttributeNS(null, 'stroke', 'black');
  if(f){
    rect.setAttributeNS(null, 'fill', f);
    rect.setAttributeNS(null, 'fill-opacity', '0.7');
  }
  document.getElementById(source).appendChild(rect);
}
function ajouteNb(x, y, n, source = "leSvg"){
  var txt = document.createElementNS(svgNS, "text")
  txt.setAttributeNS(null,"x", x)
  txt.setAttributeNS(null,"y", y)
  txt.setAttributeNS(null,"fill", 'black')
  txt.setAttributeNS(null,"font-size", "10px")
  txt.setAttributeNS(null,"dominant-baseline", "middle")
  txt.setAttributeNS(null,"text-anchor", "middle")
  txt.innerHTML = n
  document.getElementById(source).appendChild(txt)
}
function ajouteLigne(pt1, pt2, coul = "black", source = "leSvg"){
  var lig = document.createElementNS(svgNS, 'line')
  lig.setAttributeNS(null, "x1", pt1[0])
  lig.setAttributeNS(null, "y1", pt1[1])
  lig.setAttributeNS(null, "x2", pt2[0])
  lig.setAttributeNS(null, "y2", pt2[1])
  lig.setAttributeNS(null, "stroke-width", 1)
  lig.setAttributeNS(null, "stroke", coul)
  if(coul == "maroon"){
    lig.setAttributeNS(null, "stroke-dasharray", 12)
  } else if (coul == "green"){
    lig.setAttributeNS(null, "stroke-dasharray", '1, 8')
  }
  document.getElementById(source).appendChild(lig)
}
function ajouteTexte(centre, t, coul = "black", source = "leSvg"){
  var txt = document.createElementNS(svgNS, "text")
  txt.setAttributeNS(null,"x", centre[0])
  txt.setAttributeNS(null,"y", centre[1])
  if(coul == "orange"){
    txt.setAttributeNS(null,"font-weight", "bolder")    
    txt.classList.add("draggable")
  } else {
    txt.classList.add("detacher")
		txt.addEventListener('click', clicDetacher);
    
    var L = Lignes.filter(x => (x.triP == t) && (x.etat == 'C'))
  }
  txt.setAttributeNS(null,"fill", coul)
  txt.setAttributeNS(null,"font-size", tP1 + "px")
  txt.setAttributeNS(null,"dominant-baseline", "middle")
  txt.setAttributeNS(null,"text-anchor", "middle")
  txt.innerHTML = t
  decoSiRecherche(txt, t)
  
  document.getElementById(source).appendChild(txt)
}
function decoSiRecherche(txt, t){
  var r = document.getElementById("rech").value
  if(r &&(r == t)){
    txt.setAttributeNS(null,"font-weight", "bolder")
    txt.setAttributeNS(null,"fill", "red")
  }
}
function ajouteTexte2(pt1, pt2, pt3, p, t, coul = "black", source = "leSvg"){
  var svg = document.getElementById(source)
  var txt = document.createElementNS(svgNS, "text")
  centre = milieu(pt1, pt2)
  pt = deplace(centre[0], centre[1], tP2-3, centre[0], centre[1], pt3[0], pt3[1])
  txt.setAttributeNS(null,"x", pt[0])
  txt.setAttributeNS(null,"y", pt[1])
  txt.classList.add("attacher")

  if(!poseCourant){
		poseCourant = document.getElementById("courant").value
	}
	
	var v = donnees.pages[pCourante-1].find(x => x.n == poseCourant)
	if(v.lies){
		var v2 = v.lies.filter(x => x.l == t)
		if(v2.length > 0){
			coul = "blue"
		}
	}
	 
  txt.setAttributeNS(null,"fill", coul)
  txt.setAttributeNS(null,"font-size", tP2 + "px")
  txt.setAttributeNS(null,"dominant-baseline", "middle")
  txt.setAttributeNS(null,"text-anchor", "middle")
  var a = rad2deg(angle(pt1, pt2))
  txt.setAttributeNS(null,"transform", "rotate(" 
    + (a+180)
    + "," + pt[0]
    + "," + pt[1]
    +")")
  txt.innerHTML = t

  decoSiRecherche(txt, t)
  
  svg.appendChild(txt)
  txt.setAttribute("tag", p + "," + t)
  txt.addEventListener('click', clicAttacher);
} 
function clicAttacher(evt){
	el = evt.target
	d = el.getAttribute("tag").split(",").map(x=>parseInt(x))
	
	if(!poseCourant){ poseCourant = document.getElementById("courant").value}
	if(d[1] != poseCourant){
	  var t = donnees.pages[pCourante-1].find(x=>x.n == poseCourant)
	  if(!('lies' in t)){ t.lies = [] }
	
	  var ok = false
	  var v = t.lies.findIndex(x => x.l == d[1])
	  if(v > -1) {
			var v2 = t.lies.findIndex(x => x.p == d[1])
			if(v2 == -1){
			  t.lies.splice(v, 1)
			  ok = true
			}
		} else {
			ok = true
		}
		
 		if(ok){
 		  t.lies.push({p:d[0], l:d[1]})
			//sauveDonnees()
			redeploie()
		}
	}
	//console.log("clic", d,t)
}
function clicDetacher(evt){
	el = evt.target
	if(!poseCourant){
		poseCourant = document.getElementById("courant").value
	}
	var t = donnees.pages[pCourante-1].find(x=>x.n == poseCourant)
	var l = t.lies.findIndex(x => x.l == el.textContent)
	var l2 = t.lies.filter(x => x.p == el.textContent)
	
	if((l > -1) && (l2.length == 0)){
		t.lies.splice(l, 1)
		redeploie()
	}
}
function debug_triangle(p){
  ajouteTexte(p[0], "a", "blue")
  ajouteTexte(p[1], "b", "blue")
  ajouteTexte(p[2], "c", "blue")
}
function creePage(nP, l, h){
  var page = { num: nP, largeur: l, hauteur: h,
               trianglesPoses: [], triangles: [], lignes: [] }

  return page
}
function creeTriangle(nT, pT, fT, dT){
  var triangle = { num: nT, pts: pT, faces: fT }

  // recherche voisins
  var voisins = []
  for(var i = 0; i< fT.length; i++){
    var f1 = fT[i], f2 = fT[(i+1)%fT.length]
    voisins.push(rechercheVoisin(nT, [f1, f2], vol.faces))
  }

  triangle.voisins = voisins
  
  return triangle
}
function poseTriangle(nT, delta = [0,0], angle = 0){
  var triangle = vol.faces[nT]
  var pts = d2ize(triangle.map(x=> vol.vertices[x]))
  
  if (angle != 0){
      var c = centroid(pts)
      pts = pts.map(x => rotation(c[0], c[1], x[0], x[1], angle))
  }
  
  pts = pts.map(x => [x[0] + delta[0], x[1]+ delta[1]])
  var leT = creeTriangle(nT, pts, triangle)
  Triangles.push(leT)
  lec = lec.concat(nT)
  for(var i = 0; i < pts.length; i++){
    editeLigne(nT, leT.voisins[i], pts[i], pts[(i+1)%3], pts[(i+2)%3], 'C')
  }
  
  Nums.push({pt:centroid(pts), n:nT, c:"orange"})
}
function petit(a, b){ return Math.min(a, b)}
function grand(a, b){ return Math.max(a, b)}
function trouveTriangle(n){
  return Triangles.find(x => x.num === n)
}
function ajouteVoisins(t){
  ajouteTexte(milieu(t.pts[0], t.pts[1]), t.voisins[0], "green")
  ajouteTexte(milieu(t.pts[1], t.pts[2]), t.voisins[1], "green")
  ajouteTexte(milieu(t.pts[2], t.pts[0]), t.voisins[2], "green")
}
function ajouteDist(t){
  var d = t.distances.map(x=> x.toFixed(2))
  ajouteTexte(milieu(t.pts[0], t.pts[1]), d[0], "green")
  ajouteTexte(milieu(t.pts[1], t.pts[2]), d[1], "green")
  ajouteTexte(milieu(t.pts[2], t.pts[0]), d[2], "green")
}
function estCoplanaire(t, p){
// Function to find equation of plane.
// https://www.geeksforgeeks.org/program-to-check-whether-4-points-in-a-3-d-plane-are-coplanar/
var x1 = t[0][0], y1 = t[0][1], z1 = t[0][2],
      x2 = t[1][0], y2 = t[1][1], z2 = t[1][2],
      x3 = t[2][0], y3 = t[2][1], z3 = t[2][2],
      x  = p[0],    y  = p[1],    z  = p[2]

  var a1 = x2 - x1,
      b1 = y2 - y1,
      c1 = z2 - z1,
      a2 = x3 - x1,
      b2 = y3 - y1,
      c2 = z3 - z1,
      a = b1 * c2 - b2 * c1,
      b = a2 * c1 - a1 * c2,
      c = a1 * b2 - b1 * a2,
      d = (- a * x1 - b * y1 - c * z1)
// equation of plane is: a*x + b*y + c*z = 0 #  
   
// checking if the 4th point satisfies  
// the above equation  
//  return (a * x + b * y + c * z + d == 0)
  return a * x + b * y + c * z + d
}
function trouveLigneIndex(pN, gN){
  return Lignes.findIndex(x => (x.pN === pN) && (x.gN === gN))
}
function editeLigne(n1, n2, p1, p2, p3, etat){
  var pN = petit(n1, n2), gN = grand(n1, n2)
  var L = trouveLigneIndex(pN, gN)

  if(L === -1){
    Lignes.push({pN: pN, gN: gN, p1: p1, p2: p2, p3: p3, etat:etat, triP:n1, triV:n2})
  } else {
    if(etat != 'C'){
      Lignes[L].etat = etat
    } else {
      Lignes[L].p1b = p1
      Lignes[L].p2b = p2
      Lignes[L].p3b = p3
    }
  }
}
function traceLignes(){
  for(var i in Lignes){
  var L = Lignes[i]
  switch(L.etat){
    case 'C': coul = "red"
      break
    case 'M': coul = "maroon"
      break
    case 'V': coul = "green"
  }
  
  if(L.etat != 'P'){
    ajouteLigne(L.p1, L.p2, coul)
    if(L.etat == 'C'){
      ajouteTexte2(L.p1, L.p2, L.p3, L.triP, L.triV, "black")
      if(L.p1b){
        ajouteLigne(L.p1b, L.p2b, coul)
        ajouteTexte2(L.p1b, L.p2b, L.p3b, L.triV, L.triP, "black")
      }
    }
  }
}

}
function traceNums(){
  for(var i in Nums){
    var num = Nums[i]
    var nb = comptePlis(num.n)
    if(num.c == "orange"){
      var c = num.c
    } else {
      var c = (nb < 3) ? num.c : "violet"
    }
    ajouteTexte(num.pt, num.n, c)
  }
}
function comptePlis(tN){
  var n = 0
  for(var i =0; i < Lignes.length; i++){
    var L = Lignes[i]
    if ( (L.etat != 'C') && ((L.pN == tN) || (L.gN == tN)) ){
      n++
    }
  }
  return n
}
function lie(l){
  lec = lec.concat(l)
  for(var i = 0; i < l.length-1; i++){
    lieTriangle(l[i], l[i+1])
  }
}
function lieTriangle(nTPose, nTALier){
  var tPose = trouveTriangle(nTPose)
  
  lec = lec.concat(nTALier)
  
  tALier = vol.faces[nTALier]
  nv2 = tPose.voisins.indexOf(nTALier)
  nv2b = (nv2 + 1) % 3

  var pts = d2ize(tALier.map(x=> vol.vertices[x]))
  var leT = creeTriangle(nTALier, pts, tALier)
  Triangles.push(leT)

  nv1 = leT.voisins.indexOf(nTPose)
  nv1b = (nv1 + 1) % 3

  // ALIGNEMENT P1.triangle sur P2.posé
  PT1 = pts[nv1], PT2 = pts[nv1b]
  PP1 = tPose.pts[nv2], PP2 = tPose.pts[nv2b], PP3 = tPose.pts[(nv2b+1)%3]
  dk = [ PP2[0] - PT1[0], PP2[1] - PT1[1] ]
  pts = pts.map(x => [x[0] + dk[0], x[1] + dk[1]])
  PT1 = pts[nv1], PT2 = pts[nv1b]

  // ROTATION
  var distance_milieu = distance2d(milieu(PT2, PP1), PT1)
  if(distance_milieu === 0){
    ang = 180
  } else {
    A = PT2, B = PT1, C = PP1
    var a = calculeAngles([distance2d(B,C), distance2d(A,C), distance2d(A,B)])
    if(!Number.isNaN(a[1])){
      ang = rad2deg(a[1])
    } else {
      ang = 0
    }    
  }
  sauvePts = pts
  pts = pts.map(x => rotation(PP2[0], PP2[1], x[0], x[1], ang))
  var dist2 = Math.abs(distance2d(pts[nv1b], tPose.pts[nv2]))
  if(dist2 > epsilon){
    pts = sauvePts.map(x => rotation(PP2[0], PP2[1], x[0], x[1], -ang))
  }

  leT.pts = pts
  //ajouteTriangle(pts)
  for(var i = 0; i < pts.length; i++){
    editeLigne(nTALier, leT.voisins[i], pts[i], pts[(i+1)%3], pts[(i+2)%3], 'C')
  }

  //ajouteTexte(centroid(pts), nTALier)
  Nums.push({pt:centroid(pts), n:nTALier, c:"black"})

  // coplanaire
  t1 = tPose.faces.map(x => vol.vertices[x])
  t2 = tALier.map(x => vol.vertices[x])

  cp = estCoplanaire(t1, t2[(nv1b + 1)%3])
  if (cp === 0){
    editeLigne(nTPose, nTALier, PP1, PP2, PP3, "P" )
  } else {
    if (cp < 0){
      coul = "maroon"
      editeLigne(nTPose, nTALier, PP1, PP2, PP3, "M" )
    } else {
      coul = "green"
      editeLigne(nTPose, nTALier, PP1, PP2, PP3, "V" )
    }
    //ajouteLigne(PP1, PP2, coul)
  }
}
function faitTableauManquants(nP, nbT, coul){
  var x = 0, y = 25
  const L = 25
  //lec = []
  //definitPage(nP)
  l = [...new Set(lec)]; 
  var t = l.sort(function(a,b){return a > b})
  ajouteRect(25*2* parseInt(nP-1), 0, 21, 25*2, coul,"mm")
  ajouteNb(25*2* parseInt(nP-1)+24, 10, nP+":"+t.length,"mm")
  const xMax = L * (Math.sqrt(nbT)-1)

  for(var i = 0; i < nbT; i++){
    ajouteRect(x,y, L, L,'none',"mm")
    if(t.indexOf(i)> -1){
      ajouteRect(x,y, L, L, coul,"mm")
    }
    ajouteNb(x+12,y+12, i,"mm")
    if(x < xMax){
      x += L
    } else {
      x = 0
      y += L
    }
  }
}
function chargeDonnees(){
	var requestURL = "http://localhost/depl_edit/Moai156/donnees.json"
	var request = new XMLHttpRequest()
	request.open('GET', requestURL)
	request.responseType = 'json'
	request.send()
	request.onload = function(){
		donnees = request.response
		redeploie()
	}
}
function redeploie(){
  // définition des pages
  const urlParams = new URLSearchParams(window.location.search);
  nPage = urlParams.get("page")
  pCourante = nPage
  initVolume()
  var elsT = document.getElementsByTagNameNS( "http://www.w3.org/2000/svg", "text" )
  var elsP = document.getElementsByTagNameNS( "http://www.w3.org/2000/svg", "line" )
  var elsR = document.getElementsByTagNameNS( "http://www.w3.org/2000/svg", "rect" )
  Array.from(elsT).concat(Array.from(elsP), Array.from(elsR))
  .map(x=> x.parentNode.removeChild( x ))
  
	Lignes = []
	Nums = []
	Triangles = []
	lec = []

    definitPage(nPage)
    faitTableauManquants("1", vol.faces.length, "lightcoral")
    // actions de finalisation
    traceLignes()
    traceNums()
    rech.focus()
    rechEnCours = false
  //}
}		
function getJSON(path) {
// return JSON data from any file path (asynchronous)
  return fetch(path).then(response => response.json());
}
function sauveDonnees(){
	var JSONDonnees = JSON.stringify(donnees)
	download(JSONDonnees, 'donnees.json', 'application/json')
}
function sauveDonneesFixe(){
	donnees = {
		pages:[
			[	{n:0, x:750,y:550, a:0}
			]
		]
	}
	sauveDonnees()
}
function download(content, fileName, contentType) {
  var a = document.createElement("a");
  var file = new Blob([content], {type: contentType});
  a.href = URL.createObjectURL(file);
  a.download = fileName;
  a.click();
}
function definitPage(nP){
  var d = donnees.pages[nP-1]
	for(var i = 0; i < d.length; i++){
		var pose = d[i]
		poseTriangle(pose.n, [pose.x, pose.y], pose.a)
		if(!poseCourant){
		  poseCourant = pose.n
		  document.getElementById("courant").value = pose.n
		}
		var lies = d[i].lies
		if(lies){
			lies[j]
			for(var j = 0; j < lies.length; j++){
				lieTriangle(lies[j].p, lies[j].l)
			}
		}
	}
}

</script>

</body>
</html>
