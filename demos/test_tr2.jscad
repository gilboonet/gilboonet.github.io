function volume(){ return obj().csg;}
obj = function () {
let faces =[[8,107,88],[11,89,68],[16,76,160],[16,161,74],[17,29,168],[17,144,29],[17,147,144],[18,30,142],[18,167,168],[18,168,30],[19,163,64],[20,85,106],[22,84,101],[22,106,84],[23,121,70],[28,78,159],[29,144,145],[29,150,151],[30,168,169],[30,170,152],[32,83,104],[34,82,99],[34,104,82],[35,119,72],[44,81,94],[46,80,96],[46,94,80],[64,164,31],[68,89,122],[68,116,117],[68,121,23],[69,121,122],[70,114,115],[70,119,35],[70,121,120],[71,119,120],[72,95,47],[72,97,113],[72,119,118],[73,95,118],[80,94,103],[80,104,34],[82,104,105],[82,106,22],[84,106,107],[84,107,8],[95,73,45],[97,72,47],[98,96,80],[100,99,82],[102,101,84],[103,94,81],[103,104,80],[105,104,83],[105,106,82],[107,106,85],[114,70,35],[116,68,23],[118,95,72],[119,71,33],[120,119,70],[121,69,21],[122,121,68],[128,58,174],[133,59,172],[134,60,180],[139,61,182],[142,143,163],[143,142,30],[143,153,164],[144,147,146],[144,159,145],[145,150,29],[148,167,18],[149,163,162],[159,76,28],[159,78,158],[160,76,159],[160,159,144],[160,161,16],[163,149,142],[164,64,163],[164,163,143],[165,164,153],[169,168,29],[169,170,30],[171,59,186],[172,58,133],[172,59,171],[173,58,172],[174,58,173],[178,60,132],[179,60,178],[180,60,179],[180,61,134],[181,61,180],[182,61,181],[186,59,135],[4,86,5],[5,10,9],[5,86,140],[5,88,4],[5,140,1],[5,166,6],[6,10,5],[6,87,7],[6,89,10],[6,166,2],[7,89,6],[8,88,9],[9,88,5],[9,90,8],[10,13,9],[10,89,11],[10,91,14],[11,91,10],[12,90,13],[13,90,9],[14,13,10],[14,91,15],[43,156,93],[44,94,61],[45,59,95],[45,93,59],[46,96,60],[47,58,97],[47,95,58],[51,97,57],[52,92,139],[54,93,156],[55,96,48],[57,97,128],[60,94,46],[61,92,44],[87,6,141],[87,157,3],[92,61,139],[92,155,40],[94,60,134],[95,59,133],[97,58,128],[132,60,96],[132,96,55],[133,58,95],[134,61,94],[135,59,93],[135,93,54],[140,86,154],[141,6,2],[154,86,0],[155,92,52],[157,87,141],[166,5,1],[171,185,172],[172,175,173],[173,175,174],[175,172,176],[176,180,177],[177,179,178],[179,177,180],[180,176,184],[180,183,181],[181,183,182],[183,180,184],[184,172,185],[184,176,172],[185,171,186],[0,161,154],[1,140,147],[1,147,166],[2,148,141],[2,166,148],[3,157,62],[18,149,148],[29,170,169],[30,153,143],[31,164,66],[40,155,78],[41,150,52],[41,170,151],[42,153,152],[42,170,53],[53,170,41],[54,153,42],[54,165,153],[62,157,162],[62,163,19],[66,156,43],[78,155,158],[140,161,146],[141,148,149],[141,149,157],[142,149,18],[144,161,160],[145,159,150],[146,147,140],[146,161,144],[147,168,167],[148,166,167],[150,155,52],[150,159,158],[151,150,41],[151,170,29],[152,153,30],[152,170,42],[154,161,140],[156,165,54],[158,155,150],[161,0,74],[162,157,149],[163,62,162],[165,66,164],[165,156,66],[167,166,147],[168,147,17],[4,107,85],[4,112,86],[7,69,89],[7,87,69],[11,68,91],[15,91,63],[20,105,83],[20,110,111],[20,112,85],[21,71,121],[21,126,71],[23,70,116],[24,101,75],[27,116,65],[32,103,81],[32,108,109],[32,110,83],[33,73,119],[33,124,73],[35,72,114],[36,99,77],[39,114,67],[41,52,138],[41,137,53],[42,136,54],[42,137,136],[44,92,81],[48,96,79],[49,131,55],[50,129,56],[53,137,42],[54,136,135],[55,131,132],[56,129,130],[56,131,49],[57,129,50],[63,91,117],[63,116,27],[65,114,39],[65,116,115],[67,97,51],[67,114,113],[69,87,127],[69,126,21],[71,124,33],[71,126,125],[73,93,45],[73,124,123],[75,90,12],[75,101,102],[77,99,100],[77,101,24],[79,96,98],[79,99,36],[80,99,98],[81,92,108],[81,108,32],[82,101,100],[83,110,20],[84,90,102],[85,112,4],[88,107,4],[90,84,8],[98,99,79],[99,80,34],[100,101,77],[101,82,22],[102,90,75],[104,103,32],[106,105,20],[109,110,32],[111,112,20],[113,97,67],[113,114,72],[115,114,65],[115,116,70],[117,91,68],[117,116,63],[118,119,73],[120,121,71],[122,89,69],[123,93,73],[125,124,71],[127,126,69],[128,129,57],[130,131,56],[138,137,41],[139,138,52],[3,62,87],[13,26,25],[13,75,12],[14,26,13],[14,63,26],[15,63,14],[16,110,76],[16,112,111],[19,64,126],[24,75,25],[25,75,13],[25,77,24],[26,37,25],[26,63,27],[26,65,38],[27,65,26],[28,108,78],[28,110,109],[31,66,124],[36,55,79],[36,77,37],[37,55,36],[37,56,49],[37,77,25],[38,37,26],[38,56,37],[38,57,50],[38,65,39],[39,57,38],[40,78,92],[48,79,55],[49,55,37],[50,56,38],[57,67,51],[62,126,127],[64,124,125],[66,93,123],[67,57,39],[74,0,112],[74,112,16],[76,110,28],[86,112,0],[93,66,43],[108,92,78],[109,108,28],[111,110,16],[123,124,66],[124,64,31],[125,126,64],[126,62,19],[127,87,62],[130,129,176],[132,131,178],[135,136,186],[137,138,184],[174,129,128],[175,129,174],[176,129,175],[176,131,130],[177,131,176],[178,131,177],[182,138,139],[183,138,182],[184,136,137],[184,138,183],[185,136,184],[186,136,185]],
vertices = [[-0.97,-0.98,-1.25],[-0.97,-0.98,-0.42],[-0.98,-0.98,0.42],[-0.98,-0.98,1.25],[-0.98,-0.32,-1.25],[-0.98,-0.32,-0.42],[-0.98,-0.32,0.42],[-0.98,-0.32,1.25],[-0.98,0.35,-1.25],[-0.98,0.35,-0.42],[-0.98,0.35,0.42],[-0.98,0.35,1.25],[-0.98,1.02,-1.25],[-0.98,1.02,-0.42],[-0.98,1.02,0.42],[-0.99,1.02,1.25],[-0.31,-0.98,-1.25],[-0.31,-0.98,-0.42],[-0.31,-0.98,0.42],[-0.31,-0.98,1.25],[-0.31,-0.32,-1.25],[-0.31,-0.32,1.25],[-0.31,0.35,-1.25],[-0.31,0.34,1.25],[-0.31,1.02,-1.25],[-0.31,1.02,-0.42],[-0.31,1.02,0.41],[-0.31,1.02,1.25],[0.35,-0.98,-1.25],[0.35,-0.98,-0.41],[0.35,-0.98,0.41],[0.35,-0.98,1.24],[0.35,-0.31,-1.25],[0.35,-0.32,1.25],[0.35,0.35,-1.25],[0.35,0.34,1.25],[0.35,1.01,-1.25],[0.35,1.01,-0.42],[0.35,1.01,0.41],[0.35,1.01,1.25],[1.02,-0.98,-1.24],[1.02,-0.98,-0.41],[1.02,-0.98,0.41],[1.01,-0.98,1.24],[1.02,-0.31,-1.25],[1.02,-0.32,1.25],[1.02,0.35,-1.25],[1.02,0.35,1.25],[1.02,1.01,-1.24],[1.02,1.01,-0.41],[1.02,1.01,0.42],[1.01,1.01,1.26],[0.88,-0.88,-0.83],[1.11,-1.12,-0.03],[0.88,-0.88,0.82],[0.88,1.01,-0.83],[1.1,1.01,-0.02],[0.88,1.01,0.84],[0.89,0.35,0.84],[0.89,-0.32,0.83],[0.89,0.35,-0.83],[0.89,-0.32,-0.83],[-0.65,-0.98,1.2],[-0.65,1.02,1.2],[0.02,-0.98,1.3],[0.02,1.01,1.3],[0.68,-0.98,1.19],[0.69,1.01,1.2],[-0.64,0.35,1.2],[-0.64,-0.32,1.2],[0.02,0.34,1.3],[0.02,-0.32,1.3],[0.69,0.35,1.2],[0.68,-0.32,1.2],[-0.64,-0.98,-1.2],[-0.65,1.02,-1.2],[0.02,-0.98,-1.3],[0.02,1.02,-1.3],[0.69,-0.98,-1.19],[0.69,1.01,-1.2],[0.69,0.35,-1.2],[0.69,-0.31,-1.2],[0.02,0.35,-1.3],[0.02,-0.32,-1.3],[-0.65,0.35,-1.2],[-0.65,-0.32,-1.2],[-0.98,-0.65,-1.2],[-0.98,-0.65,1.2],[-0.98,0.02,-1.3],[-0.98,0.02,1.3],[-0.98,0.68,-1.2],[-0.98,0.67,1.2],[0.92,-0.64,-1.19],[0.91,-0.66,1.19],[1.12,0.02,-1.3],[1.12,0.03,1.29],[0.92,0.68,-1.2],[0.91,0.67,1.2],[0.69,0.68,-1.15],[0.35,0.68,-1.2],[0.02,0.68,-1.25],[-0.31,0.68,-1.2],[-0.65,0.68,-1.15],[0.69,0.02,-1.25],[0.35,0.02,-1.3],[0.02,0.02,-1.35],[-0.31,0.02,-1.3],[-0.65,0.02,-1.25],[0.69,-0.64,-1.14],[0.35,-0.65,-1.2],[0.02,-0.65,-1.25],[-0.31,-0.65,-1.2],[-0.65,-0.65,-1.15],[0.69,0.67,1.15],[0.35,0.67,1.2],[0.02,0.67,1.25],[-0.31,0.67,1.2],[-0.65,0.67,1.15],[0.68,0.01,1.25],[0.35,0.01,1.3],[0.02,0.01,1.35],[-0.31,0.01,1.3],[-0.64,0.01,1.25],[0.68,-0.66,1.14],[0.35,-0.66,1.19],[0.02,-0.66,1.25],[-0.31,-0.66,1.2],[-0.64,-0.65,1.15],[0.78,0.67,0.83],[0.92,0.68,0.41],[1,0.68,-0.02],[0.92,0.68,-0.42],[0.78,0.68,-0.83],[0.99,0.03,0.83],[0.99,0.02,-0.83],[0.79,-0.65,0.82],[0.92,-0.65,0.4],[1.01,-0.65,-0.03],[0.92,-0.65,-0.42],[0.78,-0.65,-0.83],[-0.97,-0.88,-0.83],[-0.98,-0.88,0.83],[-0.31,-0.88,0.83],[0.35,-0.88,0.82],[-0.31,-0.88,-0.83],[0.35,-0.88,-0.83],[-0.65,-0.88,-0.83],[-0.64,-0.98,-0.42],[-0.64,-0.98,0.42],[-0.65,-0.88,0.83],[0.69,-0.88,-0.83],[0.69,-0.98,-0.41],[0.69,-0.98,0.41],[0.68,-0.88,0.82],[-0.97,-0.98,-1.04],[0.95,-0.98,-1.04],[0.95,-0.98,1.03],[-0.98,-0.98,1.04],[0.69,-0.98,-1.04],[0.35,-0.98,-1.04],[-0.31,-0.98,-1.04],[-0.65,-0.98,-1.04],[-0.65,-0.98,1.04],[-0.31,-0.98,1.04],[0.35,-0.98,1.03],[0.68,-0.98,1.03],[-0.97,-1.08,0],[-0.64,-1.08,0],[-0.31,-1.08,-0.01],[0.35,-1.08,-0.02],[0.69,-1.08,-0.03],[-0.7,-0.32,0.83],[-0.7,0.03,0.83],[-0.7,0.35,0.84],[-0.7,0.67,0.83],[-0.7,0.68,0.41],[-0.7,0.68,-0.02],[-0.7,0.68,-0.42],[-0.7,0.68,-0.83],[-0.7,0.35,-0.83],[-0.7,0.02,-0.83],[-0.7,-0.32,-0.83],[-0.7,-0.65,-0.83],[-0.7,-0.65,-0.42],[-0.7,-0.65,-0.03],[-0.7,-0.65,0.41],[-0.7,-0.65,0.83]],
groups = [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],
faceCsg = faces.map(m => CSG.Polygon.createFromPoints(m.map(n => vertices[n]))),
csg = CSG.fromPolygons(faceCsg);
return {faces:faces, vertices:vertices, groups:groups, faceCsg:faceCsg, csg:csg};
};

function getParameterDefinitions() {
  return [
    { name: 't0', type:'group', caption:'TRANCHAGE 2 AXES'},
    { name: 'ech',type: 'number', initial: 1, caption: 'Echelle' }, 
    { name: 'rX', type: 'int',   initial: 0, caption: 'Rotation X:' },
    { name: 'rY', type: 'int',   initial: 0, caption: 'Rotation Y:' },
    { name: 'rZ', type: 'int',   initial: 0, caption: 'Rotation Z:' },
    { name: 'nbC',type: 'int', initial: 3, caption: 'Nb Colonnes (beige)' },
    { name: 'CM', type: 'text', initial: '', caption: 'Colonnes?'}, 
    { name: 'nbL',type: 'int', initial: 3, caption: 'Nb Lignes (orange)' },
    { name: 'LM', type: 'text', initial: '', caption: 'Lignes?'}, 
    { name: 'eC', type: 'int', initial: 3, caption: 'Ep. Carton (mm)' },
    { name: 'mode',type: 'choice', initial: 1, caption:'Mode', captions:['Vue 3d','Vue 3d eclatee V', 'Vue 3d eclatee H', 'Vue 2d'], values:[30,31,32,2]},
    { name: 't1',  type: 'group', caption:'Gabarit'},
    { name: 'larg', type: 'number', initial: 210, caption: 'Largeur (mm)' }, 
    { name: 'haut', type: 'number', initial: 297, caption: 'Hauteur (mm)' }
  ];
}

function ajoutePtsDePoly(poly){
	var ret = [];
	for (var np = 0; np < poly.sides.length; np++){
		var sp = poly.sides[np];
		ret.push({t:2,
  		x1: 4 + sp.vertex0.pos.x, y1: 4 + sp.vertex0.pos.y,
			x2: 4 + sp.vertex1.pos.x, y2: 4 + sp.vertex1.pos.y
		});
	}
	return ret;
}

function main(){

var r2d = [], v, tmp, i, b, tr, d, bz, t2, t3, t4, n, colsM, ligsM, CM, LM;
var nLignes = [], nColonnes = [], rL = [], rC = [], urL, urC;

// volume
v = center(true, scale(params.ech, rotate([params.rX, params.rY, params.rZ], volume())));
b = v.getBounds();
d = b[1].minus(b[0]);

if(params.LM === ''){
  ligsM = [];
  LM = -1;
} else {
  ligsM = params.LM.split(',').map(Number);
}
n = 0;
for(i = 0.5; i< params.nbL; i++){ // lignes
  if(ligsM.length > 0){
    LM = ligsM[n];
    n++;
  }
  tr =rotate([90,0,0], faitLigne(i, v, params.nbL, params.eC, LM));
  bz = tr.getBounds()[0].z;
  tr = union(vol2surf(tr, bz));
  tr = translate([0,bz +3, 0], rotate([-90,0,0], tr.extrude({offset:[0,0,params.eC]})));
  rL = rL.concat(tr);
}
urL = union(rL);

if(params.CM === ''){
	colsM = [];
  CM = -1;
} else {
  colsM = params.CM.split(',').map(Number);
}
//console.log('XX', colsM);
n = 0;
for(i = 0.5; i < params.nbC; i++){ // colonnes
  if(colsM.length > 0){
    CM = colsM[n];
    n++;
  }
  tr =rotate([0,90,0], faitColonne(i, v, params.nbC, params.eC, CM));
  bz = tr.getBounds()[0].z;
  tmp = union(vol2surf(tr, bz));
  tr = translate([-bz, 0, 0], rotate([0,-90,0], tmp.extrude({offset:[0,0,params.eC]})));
  rC = rC.concat(tr);
}
urC = union(rC);

tmp = scission3d(urC.intersect(urL)); // encoches
var miH = [], miB = [], miT = [];
for(i = 0; i < tmp.length; i++){
  var tt = diviseVolume(tmp[i], d);
  miH.push(tt[1]);
  miB.push(tt[2]);
  miT.push(tt[0]);
}
var umiH = union(miH), umiB = union(miB);
var data = [];

if (params.mode == 2){ // rendu 2d
  var r = [], n, t2, t3, h;

  for(n = 0; n < rL.length; n++){
      t2 = rL[n].subtract(miT);
      t3 = t2.union(rL[n].intersect(umiH));
    r.push(translate([-params.larg * n, 0],
      square({size:[params.larg+4, params.haut+4], center:true})
      .subtract(square({size:[params.larg, params.haut], center:true}))));
		t4 = tourneEt2d(t3, [90, 0, 0]);
    r.push(translate([-params.larg * n, 2], t4));

		t4 = translate(t4.getBounds()[0].times(-1), t4);
		if(n > 0){ data.push({t:4}); }
		data.push(...ajoutePtsDePoly(t4));
  }

  h = params.haut;
  for(n = 0; n < rC.length; n++){
    t2 = rC[n].subtract(miT);
    t3 = t2.union(rC[n].intersect(umiB));
    r.push(translate([-params.larg*n, h],
      square({size:[params.larg+4, params.haut+4], center:true})
      .subtract(square({size:[params.larg, params.haut], center:true}))));
		t4 = tourneEt2d(t3, [0, -90, 0]);
    r.push(translate([-params.larg*n, h+2], t4));

		t4 = translate(t4.getBounds()[0].times(-1), t4);
		data.push({t:4});
		data.push(...ajoutePtsDePoly(t4));
  } 
 
	var dexport = JSON.stringify(data);
//	try{
	localStorage.setItem("tr1_data", dexport);
	localStorage.setItem("tr1_dx", params.larg);
	localStorage.setItem("tr1_dy", params.haut);
//	}catch(err){};
//  console.log(dexport);

  return r;
    
} else { // rendu 3d
  var ee, cv;
  if (params.mode == 30){
    ee = 0;
    cv = [1,0,0,0.2];
  } else {
    ee = 1.2;
    cv = "crimson";
  }

	if(params.mode == 31){
	  return [color("tan", translate([0, d.y * ee, d.z / 2], urC.subtract(miT).union(miB)))
		       ,color("orange", translate([0, -d.y * ee, d.z / 2], urL.subtract(miT).union(miH)))
		         ,color(cv, translate([0, 0, d.z / 2], v))
		  ];
	} else {
    return [color("tan", translate([d.x * ee, 0, d.z / 2], urC.subtract(miT).union(miB)))
           ,color("orange", translate([-d.x * ee, 0, d.z / 2], urL.subtract(miT).union(miH)))
           ,color(cv, translate([0, 0, d.z / 2], v))
      ];
  }
}
}

function tourneEt2d(vol, angle){
  var t = rotate(angle, vol);
  return union(vol2surf(t, t.getBounds()[1].z));
}

function faitColonne(i, V, nbC, ec, CM){
	//console.log(CM);
	var vb = V.getBounds();
	var vd = vb[1].minus(vb[0]);
  var tNc1 = [[0, vb[0].x],[nbC, vb[1].x]];
  var b2 = lookup((CM > -1 ? CM : i), tNc1);
  var tmp = translate([b2 -ec, -500, -500], cube({size:[ec, 1000, 1000], center:false}));
  return V.intersect(tmp);
}

function faitLigne(i, V, nbL, ec, LM){
  //console.log(LM);
	var vb = V.getBounds();
	var vd = vb[1].minus(vb[0]);
  var tNl1 = [[0, vb[0].y],[nbL, vb[1].y]];
  var b2 = lookup((LM > -1 ? LM: i), tNl1);
  var tmp = translate([-500, b2 -ec, -500], cube({size:[1000, ec, 1000], center:false}));
  return V.intersect(tmp);
}

function diviseVolume(vol, volD){
  var b = vol.getBounds();
  var d = b[1].minus(b[0]);
  var cDemi = cube({size:[d.x, d.y, d.z/2], center:false});
  var cTout = translate([b[0].x, b[0].y,-500], cube({size:[d.x, d.y, 1000], center:false}));    
  return [cTout,
          vol.intersect(translate(b[0], cDemi)),
          vol.intersect(translate([b[0].x, b[0].y, b[0].z + d.z/2], cDemi))
  	];
}

function sortNb		(E){ // returns E numerically sorted and deduplicated
	return E.sort(function(a, b) {return a-b}).filter(
	    function(item, pos, ary) {return !pos || item != ary[pos - 1]});
}

function compare3d	(v1, v2){ // returns true if V1 and V2 are at the same position
	return (v1.pos.x == v2.pos.x) && (v1.pos.y == v2.pos.y) && (v1.pos.z == v2.pos.z);
}

function compare2d			(v1, v2){ // returns true if V1 and V2 are at the same position
	return (v1.pos.x == v2.pos.x) && (v1.pos.y == v2.pos.y);
}

function scission2d			(geom){
	var i,j,i1,j1,ok,ti,tj,z,zz = [], P = geom.sides, RScission = [];

// construit table de correspondance entre Polygones (P)
// build polygons lookup table
	for (i = 0; i < P.length; i++) {
		ti = [P[i].vertex0, P[i].vertex1];
		z = [];
		for (j = 0; j < P.length; j++) {
			tj = [P[j].vertex0, P[j].vertex1];
			ok = false;
			for (i1 = 0; i1 < ti.length; i1++)
				for(j1 = 0; j1 < tj.length; j1++)
					{if (!ok)ok = compare2d(ti[i1], tj[j1]);}
			if (ok){z.push(parseInt(j));}
		}
		z = sortNb(z);
		zz.push({e:0, d:z});
		// console.log(i, z.toString());
	}

// regroupe les correspondances des polygones se touchant
// boucle ne s'arrêtant que quand deux passages retournent le même nb de polygones
// merge lookup data from linked polygons as long as possible
	ok = false;
	nElOk = 0;
	do {
		lnElOk = nElOk;
		nElOk = 0;
		for (i = 0; i < zz.length; i++) {
			if (zz[i].e >= 0) {
				nElOk++;
				for (j = 0; j < zz[i].d.length; j++) {
					a = zz[i].d[j];
					if (zz[a].e >= 0)
						if (i != a) {
							zz[i].d = sortNb(zz[i].d.concat(zz[a].d));
							zz[a].e = -1;
						}
				}
			}
		}
		ok = lnElOk == nElOk;
	}while (!ok);

// construit le tableau des CAG à retourner
// build array of CAG to return
	for (i = 0; i < zz.length; i++) {
		if (zz[i].e >= 0) {
			z = [];
			for (j = 0; j < zz[i].d.length; j++)
				z.push(P[zz[i].d[j]]);
			RScission.push(CAG.fromSides(z));
		}
	}

	return RScission;
}

function scission3d	(geom){
  var i,Pl, j,i1,j1,ok,ti,tj,z,zz = [], P, RScission, til, tjl, tii1, zzl, zzdl;
// construit table de correspondance entre Polygones (P)
// build polygons lookup table
  P = geom.toPolygons();
  RScission = [];
  Pl = P.length;
  for (i = 0; i < Pl; i++){
	ti = P[i].vertices;
	z = [];
	for (j = 0; j < Pl; j++){
      tj = P[j].vertices;
	  ok = false;
	  for (i1 = 0; i1 < ti.length; i1++){
	    tii1 = ti[i1];
		for(j1 = 0; j1 < tj.length; j1++)
		  if (!ok)ok = compare3d(tii1, tj[j1]);
	  }
	  if (ok)z.push(parseInt(j));
	}
	z = sortNb(z);
	zz.push({e:0, d:z});
  }

// regroupe les correspondances des polygones se touchant
// boucle ne s'arrêtant que quand deux passages retournent le même nb de polygones
// merge lookup data from linked polygons as long as possible
  ok = false;
  nElOk = 0;
  do {
    lnElOk = nElOk;
	nElOk = 0;
	for (i = 0; i < zz.length; i++){
	  if (zz[i].e >= 0) {
	    nElOk++;
		for (j = 0; j < zz[i].d.length; j++){
		  a = zz[i].d[j];
		  if (zz[a].e >= 0)
		    if (i != a) {
			  zz[i].d = sortNb(zz[i].d.concat(zz[a].d));
			  zz[a].e = -1;
			}
		}
	  }
	}
	ok = lnElOk == nElOk;
  }while (!ok);

// construit le tableau des CSG à retourner
// build array of CSG to return
  for (i = 0, zzl = zz.length; i < zzl; i++) {
    if (zz[i].e >= 0) {
	  z = [];
	  for (j = 0, zzdl = zz[i].d.length; j < zzdl; j++)
	    z.push(P[zz[i].d[j]]);
	  RScission.push(CSG.fromPolygons(z));
	}
  }

  return RScission;
}
// retourne la surface formee par le volume avec l'axe z (à 0)
function vol2surf(vol, orig = 0){
var n, pts, ok, P, i, pt;
let S = [];

for(n = 0; n < vol.polygons.length; n++){
  pts = [];
  P = vol.polygons[n];
  ok = true;
  for(i=0; (i < P.vertices.length) && ok; i++){
    pt = P.vertices[i].pos;
    if(Math.abs(toFixedNumber(pt.z,2,10) - orig) < 0.05){
      pts.push([toFixedNumber(pt.x,2,10), toFixedNumber(pt.y,2,10)]);
      //pts.push([pt.x, pt.y]);
    } else {
      ok = false;
    }
  }
  if (ok){
    S.push(polygon(pts));
  }
}

return S;
}

function toFixedNumber(num, digits, base){
  var pow = Math.pow(base||10, digits);
  return Math.round(num*pow) / pow;
}

/*
function poseAPlat(p){
  const v1 = p.vertices[0].pos, v2 = p.vertices[1].pos, v3 = p.vertices[2].pos;
  const tC = new CSG.Connector(v1, v2.minus(v1), p.plane.normal);
  const z0xC = new CSG.Connector([0, 0, 0], [0,v2.minus(v1).length(), 0.2], [0, 0, 1]);
  const tb = tC.getTransformationTo(z0xC, false, 0);
  let pp = (CSG.fromPolygons([p]).transform(tb)).polygons[0];

  let p2 = pp.vertices.map(v => new CSG.Vector2D(v.pos._x, v.pos._y));
  let poly2D = new CSG.Path2D(p2, true);
  return poly2D;
}*/


  
